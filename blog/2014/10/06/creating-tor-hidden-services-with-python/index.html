<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta property="og:title" content="Creating Tor Hidden Services with Python &#183; Jordan Wright"><meta property="og:site_name" content="Jordan Wright"><meta property="og:url" content="https://jordan-wright.com/blog/2014/10/06/creating-tor-hidden-services-with-python/"><meta property="og:type" content="article"><meta property="og:article:published_time" content="2014-10-06T00:00:00Z"><meta property="og:article:tag" content="tor"><meta property="og:article:tag" content="python"><meta property="og:article:tag" content="hidden services"><title>Creating Tor Hidden Services with Python &#183; Jordan Wright</title><meta name=description content="Security and Programming Blog"><meta name=HandheldFriendly content="True"><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" href=https://jordan-wright.com/blog/images/favicon.ico><link rel=apple-touch-icon href=https://jordan-wright.com/blog/images/apple-touch-icon.png><link rel=stylesheet type=text/css href=https://jordan-wright.com/blog/css/screen.css><link rel=stylesheet type=text/css href=https://jordan-wright.com/blog/css/highlight.css><link rel=stylesheet type=text/css href=https://jordan-wright.com/blog/css/nav.css><link rel=stylesheet type=text/css href=https://jordan-wright.com/blog/css/fonts.css><link href=https://jordan-wright.com/blog/index.xml rel=alternate type=application/rss+xml title="Jordan Wright"><meta name=generator content="Hugo 0.154.5"><link rel=canonical href=https://jordan-wright.com/blog/2014/10/06/creating-tor-hidden-services-with-python/><script>(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)})(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-44718701-1","auto"),ga("send","pageview")</script></head><body class=nav-closed><div class=nav><h3 class=nav-title>Menu</h3><a href=# class=nav-close><span class=hidden>Close</span></a><ul><li class=nav-opened role=presentation><a href=https://jordan-wright.com/>Home</a></li><li class=nav-opened role=presentation><a href=https://jordan-wright.com/contact/>Contact</a></li><li class=nav-opened role=presentation><a href=https://jordan-wright.com/projects/>Projects</a></li><li class=nav-opened role=presentation><a href=https://jordan-wright.com/blog/>Blog</a></li><li class=nav-opened role=presentation><a href=https://raidersec.blogspot.com>Raidersec</a></li></ul><a class="subscribe-button icon-feed" href=https://jordan-wright.com/blog/index.xml>Subscribe</a></div><span class=nav-cover></span><div class=site-wrapper><header class="main-header post-head no-cover"><nav class="main-nav clearfix"><a class=menu-button href=#><span class=burger>&#9776;</span><span class=word>Menu</span></a></nav></header><main class=content role=main><article class="post post"><header class=post-header><h1 class=post-title>Creating Tor Hidden Services with Python</h1><small></small><section class=post-meta><time class=post-date datetime=2014-10-06T00:00:00Z>Oct 6, 2014
</time><span class="post-tag small"><a href=https://jordan-wright.com/blog/tags/tor/>#tor</a></span>
<span class="post-tag small"><a href=https://jordan-wright.com/blog/tags/python/>#python</a></span>
<span class="post-tag small"><a href=https://jordan-wright.com/blog/tags/hidden-services/>#hidden services</a></span></section></header><section class=post-content><img src=/blog/images/headers/hidden_services.png alt class=pure-img><h3 id=introduction>Introduction</h3><p>Tor is often used to protect the anonymity of someone who is trying to connect to a service. However, it is also possible to use Tor to protect the anonymity of a service provider via <a href=https://www.torproject.org/docs/hidden-services.html.en><em><strong>hidden services</strong></em></a>. These services, operating under the <code>.onion</code> TLD, allow publishers to anonymously create and host content viewable only by other Tor users.</p><p>The Tor project has <a href=https://www.torproject.org/docs/tor-hidden-service.html.en>instructions</a> on how to create hidden services, but this can be a manual and arduous process if you want to setup multiple services. This post will show how we can use the fantastic <code>stem</code> Python library to automatically create and host a Tor hidden service.</p><h3 id=creating-hidden-services-manually>Creating Hidden Services Manually</h3><p>The <a href=https://www.torproject.org/docs/tor-hidden-service.html.en#two>instructions provided by the Tor project</a> show that creating hidden services simply involves setting up the service locally (such as a web server listening on localhost), and then setting a few configuration options to make the service available via Tor.</p><p>There are two configuration settings necessary to setup a hidden service: <code>HiddenServiceDir</code>, the directory to store the <code>hostname</code> and <code>private_key</code> files, and <code>HiddenServicePort</code>, the ports used to proxy hidden service connections.</p><p>As the instructions show, each hidden service requires a variation of the following two lines to be present in the <code>torrc</code> configuration file (setting the directory, host, and ports appropriately):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>HiddenServiceDir /path/to/store/hidden_service/
</span></span><span class=line><span class=cl>HiddenServicePort 80 127.0.0.1:5000
</span></span></code></pre></div><h3 id=a-bit-about-the-tor-control-protocol>A Bit About the Tor Control Protocol</h3><p>Changing the configuration file and restarting Tor everytime a change is needed can be a pain. Fortunately, Tor provides a way to dynamically change the running configuration using a simple text based protocol (similar to Telnet) called the Tor Control Protocol.</p><p>The <a href="https://gitweb.torproject.org/torspec.git?a=blob_plain;hb=HEAD;f=control-spec.txt">full specification</a> of the protocol is available, however here is a quick example of getting the valid authentication methods:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>$ telnet localhost 9151
</span></span><span class=line><span class=cl>PROTOCOLINFO
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>250-PROTOCOLINFO 1
</span></span><span class=line><span class=cl>250-AUTH METHODS=COOKIE,SAFECOOKIE,HASHEDPASSWORD COOKIEFILE=&#34;Tor\\control_auth_cookie&#34;
</span></span><span class=line><span class=cl>250-VERSION Tor=&#34;0.2.4.24&#34;
</span></span><span class=line><span class=cl>250 OK
</span></span></code></pre></div><p>Other examples using this extensive protocol can be found <a href=https://www.thesprawl.org/research/tor-control-protocol/>here</a> or in the full protocol spec.</p><h3 id=introducing-stem>Introducing Stem</h3><p>To make interacting with the Tor control port both easier and programmatic, the Tor project maintains a fantastic Python library called <a href=https://stem.torproject.org/>Stem</a>.</p><h4 id=stemcontroller><code>stem.Controller</code></h4><p>Interaction with the Tor control port is performed using the <code>stem.Controller</code> class. Creating an instance of the class involves connecting to the port and authenticating as follows:</p><pre tabindex=0><code>from stem.control import Controller
controller = Controller.from_port(address=&#34;127.0.0.1&#34;, port=9151)
try:
    controller.authenticate(password=&#34;&#34;)
except Exception as e:
    print e
</code></pre><p>Now that we have a Controller, we can access the local configuration, pull the current descriptors for relays, and more.</p><p>Let&rsquo;s use the Controller to automatically set the configuration settings we saw in the previous section. When set, these configuration options will cause Tor to create the two files, <code>hostname</code> and <code>private_key</code>, necessary to run the hidden service. Here is a short script that will setup a hidden service to listen on TCP port 80 and proxy all requests to an (already established) web server listening on http://127.0.0.1:5000:</p><pre tabindex=0><code>host = &#34;127.0.0.1&#34;
port = 5000
hidden_svc_dir = &#34;/tmp/hidden_service/&#34;
controller.set_options([
    (&#34;HiddenServiceDir&#34;, hidden_svc_dir),
    (&#34;HiddenServicePort&#34;, &#34;80 %s:%s&#34; % (host, str(port)))
])
svc_name = open(hidden_svc_dir + &#34;/hostname&#34;, &#34;r&#34;).read().strip()
print &#34;Created host: %s&#34; % svc_name
</code></pre><p>Easy as that! Now that we have the configuration setup, our service should be ready to go.</p><h3 id=an-example-service>An Example Service</h3><p>Now that we&rsquo;ve seen a little about how Stem works, here&rsquo;s an extremely basic example showing how the hidden service can be setup to work with a Flask application:</p><pre tabindex=0><code>from stem.control import Controller
from flask import Flask

if __name__ == &#34;__main__&#34;:

    app = Flask(&#34;example&#34;)
    port = 5000
    host = &#34;127.0.0.1&#34;
    hidden_svc_dir = &#34;c:/temp/&#34;

    @app.route(&#39;/&#39;)
    def index():
        return &#34;&lt;h1&gt;Tor works!&lt;/h1&gt;&#34;
    print &#34; * Getting controller&#34;
    controller = Controller.from_port(address=&#34;127.0.0.1&#34;, port=9151)
    try:
        controller.authenticate(password=&#34;&#34;)
        controller.set_options([
            (&#34;HiddenServiceDir&#34;, hidden_svc_dir),
            (&#34;HiddenServicePort&#34;, &#34;80 %s:%s&#34; % (host, str(port)))
            ])
        svc_name = open(hidden_svc_dir + &#34;/hostname&#34;, &#34;r&#34;).read().strip()
        print &#34; * Created host: %s&#34; % svc_name
    except Exception as e:
        print e
    app.run()
</code></pre><p>Here&rsquo;s what this looks like in action:</p><pre tabindex=0><code>C:\&gt;python tor_example.py
 * Getting controller
 * Created host: 4yrbax6gwnemqh7n.onion
 * Running on http://127.0.0.1:5000/
</code></pre><img src=/blog/images/blog/hidden_services/screenshot.png><h3 id=caveats>Caveats</h3><p>It is important to note that the security of the hidden service depends on protecting the location of the server. To do this, consider ways to prevent leaking the real server IP through debug messages, etc. There has been some <a href="https://news.ycombinator.com/item?id=8404511">great discussion</a> on the topic that might be worth looking into.</p><h3 id=conclusion>Conclusion</h3><p>Hidden services deliver freedom of speech and the free exchange of ideas without censorship. By using Stem Python library, it&rsquo;s possible to take the pain out of manual configuration and instead programmatically create and manage multiple hidden services.</p><p>As always, let me know if you have any questions or comments.</p><p>-Jordan (<a href=http://twitter.com/jw_sec>@jw_sec</a>)</p></section><footer class=post-footer><figure class=author-image><a class=img href=https://jordan-wright.com/blog/ style=background-image:url(https://jordan-wright.com/blog/images/jordan-profile.jpg)><span class=hidden>Jordan Wright's Picture</span></a></figure><section class=author><h4><a href=https://jordan-wright.com/blog/>Jordan Wright</a></h4><p>Security Researcher, Open-Source Developer.</p><div class=author-meta><span class="author-location icon-location">Texas</span></div></section><section class=share><h4>Share this post</h4><a class=share-link href="https://twitter.com/intent/tweet?text=Creating%20Tor%20Hidden%20Services%20with%20Python&nbsp;-&nbsp;Jordan%20Wright&amp;url=https%3a%2f%2fjordan-wright.com%2fblog%2f2014%2f10%2f06%2fcreating-tor-hidden-services-with-python%2f" onclick='return window.open(this.href,"x-share","width=550,height=235"),!1'><svg class="share-icon" viewBox="0 0 24 24" aria-hidden="true" focusable="false"><path d="M18.244 2.25h3.308l-7.227 8.26 8.503 11.24h-6.68l-5.23-6.84-6.02 6.84H1.59l7.73-8.812L1.16 2.25h6.85l4.73 6.25 5.504-6.25zm-1.16 17.52h1.833L6.71 4.126H4.745L17.084 19.77z"/></svg>
<span class=hidden>X</span>
</a><a class=share-link href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fjordan-wright.com%2fblog%2f2014%2f10%2f06%2fcreating-tor-hidden-services-with-python%2f&amp;t=Creating%20Tor%20Hidden%20Services%20with%20Python" onclick='return window.open(this.href,"hn-share","width=600,height=400"),!1'><svg class="share-icon" viewBox="0 0 24 24" aria-hidden="true" focusable="false"><path fill-rule="evenodd" d="M0 24V0h24v24H0zM6.951 5.896l4.112 7.708v5.064h1.583v-4.972l4.148-7.799h-1.749l-2.457 4.875c-.372.745-.688 1.434-.688 1.434s-.297-.708-.651-1.434L8.831 5.896h-1.88z"/></svg>
<span class=hidden>Hacker News</span>
</a><a class=share-link href="https://www.linkedin.com/sharing/share-offsite/?url=https%3a%2f%2fjordan-wright.com%2fblog%2f2014%2f10%2f06%2fcreating-tor-hidden-services-with-python%2f" onclick='return window.open(this.href,"linkedin-share","width=600,height=500"),!1'><svg class="share-icon" viewBox="0 0 24 24" aria-hidden="true" focusable="false"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853.0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.6.0 4.264 2.37 4.264 5.455v6.286zM5.337 7.433a2.062 2.062.0 110-4.123 2.062 2.062.0 010 4.123zM6.814 20.452H3.861V9h2.953v11.452zM22.225.0H1.771C.792.0.0.774.0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2.0 22.222.0z"/></svg>
<span class=hidden>LinkedIn</span></a></section></footer></article></main></div><script type=text/javascript src=https://jordan-wright.com/blog/js/jquery.js defer></script><script type=text/javascript src=https://jordan-wright.com/blog/js/index.js defer></script></body></html>